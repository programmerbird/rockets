#!/bin/bash

ROCKETDIR=`pwd`
SCRIPTDIR=$(dirname $(dirname $(dirname $(readlink -f $0))))
DATABASE_NAME=`ls ~/.rocket`
REQUIREMENTS="""
Django==1.1.1
Fabric==0.9.0
-e svn+https://svn.apache.org/repos/asf/incubator/libcloud/trunk@921044#egg=apache_libcloud-0.3.0-py2.6-dev_r921044
-I $SCRIPTDIR/build/rockets.tar.gz
"""

while [ ! -d "$ROCKETDIR/.rockets" ] 
do
	if [ "$ROCKETDIR" == "/" ]
	then
		ROCKETDIR=""
		break 
	fi
	ROCKETDIR=$(dirname "$ROCKETDIR")
done


if [ ! -z $ROCKETDIR ]
then
	$ROCKETDIR/.rockets/bin/python $ROCKETDIR/manage.py $1 $2 $3 $4 $5 $6 $7 $8 $9
else
	if [ "$1" == "init" ]
	then
		ROCKETDIR=`pwd`
		virtualenv .rockets
		for X in $REQUIREMENTS
		do
			$ROCKETDIR/.rockets/bin/pip install "$X"
		done
		cd $ROCKETDIR
		$ROCKETDIR/.rockets/bin/python -m rockets.servers.bootstrap "$ROCKETDIR"
		sed -i "s@^DATABASE_NAME\s*\=.*@DATABASE_NAME = '$DATABASE_NAME'@g" $ROCKETDIR/settings.py
		$ROCKETDIR/.rockets/bin/python $ROCKETDIR/manage.py syncdb 
	else
		echo "fatal: Not a rocket (or any of the parent directories): .rockets"
	fi
fi

